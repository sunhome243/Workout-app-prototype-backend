# Use the specified python:3.12.7-bookworm base image
FROM python:3.12.7-bookworm

# Set the working directory in the container
WORKDIR /app

# Upgrade pip
RUN pip install --upgrade pip

# Copy the requirements file into the container
COPY requirements.txt .

# Install the dependencies from requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Install Uvicorn and Gunicorn for running FastAPI
RUN pip install "uvicorn[standard]" gunicorn

# Copy only the relevant service code
COPY ./backend/user_service /app/backend/user_service
COPY ./backend/__init__.py /app/backend/

# Copy the main application files
COPY ./backend/user_service/main.py ./backend/user_service/crud.py ./backend/user_service/models.py ./backend/user_service/utils.py ./backend/user_service/schemas.py ./

# Copy Firebase-related files
COPY firebase_admin_init.py firebase.json ./

# Corrected: Copy the .env file (relative to the Docker build context)
COPY .env .env

# Expose the port FastAPI will run on
EXPOSE 8000

# Set the command to run the app using Gunicorn with Uvicorn workers
CMD ["gunicorn", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "main:app", "--bind", "0.0.0.0:80"]
